<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éš”ç©ºä½“æ„Ÿä¹å™¨ - çº¯å‡€ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ç§»é™¤å¤–éƒ¨å­—ä½“ä¾èµ–ï¼Œä½¿ç”¨ç³»ç»Ÿç­‰å®½å­—ä½“ç¡®ä¿åƒç´ é£æ ¼ */
        body {
            font-family: monospace, sans-serif; 
            background-color: #2c3e50; /* æ·±è“è‰²èƒŒæ™¯ */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #ecf0f1;
        }

        #app-container {
            background-color: #34495e; /* ç¨æµ…çš„å®¹å™¨èƒŒæ™¯ */
            border: 4px solid #f39c12; /* æ©™è‰²è¾¹æ¡† */
            box-shadow: 4px 4px 0px #e67e22; /* åƒç´ åŒ–é˜´å½± */
            padding: 1rem;
            max-width: 90vw;
            width: 1000px;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            align-items: center;
            border-radius: 8px; /* å¢åŠ åœ†è§’ */
        }

        /* ç§»é™¤äº† pixel-button æ ·å¼ï¼Œå› ä¸ºå·²æ”¹ä¸ºè‡ªåŠ¨å¯åŠ¨ */

        #video-canvas-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            aspect-ratio: 4/3; 
            border: 2px solid #95a5a6;
            border-radius: 4px;
            overflow: hidden;
        }

        #output-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            background-color: #000000;
        }

        #video-element {
            display: none; 
        }

        .loading-animation {
            animation: pulse 1s infinite alternate;
        }

        @keyframes pulse {
            from { opacity: 1; }
            to { opacity: 0.7; }
        }
    </style>
    <!-- å¼•å…¥ Firebase/Firestore å’Œ Auth -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // è®¾ç½® Firebase é…ç½®å’Œ App ID
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        if (Object.keys(firebaseConfig).length > 0) {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app); 
            setLogLevel('debug'); 

            window.authInstance = auth;
            window.onAuthStateChanged = onAuthStateChanged;

            // ä¿®å¤äº†ä¹‹å‰çš„å˜é‡åé”™è¯¯ï¼Œç¡®ä¿æ­£ç¡®è¯»å–åˆå§‹è®¤è¯ä»¤ç‰Œ
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            async function authenticate() {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Firebase è®¤è¯å¤±è´¥:", error);
                }
            }
            authenticate();
        }
    </script>
</head>
<body class="flex flex-col items-center justify-center p-4">

    <div id="app-container">
        <h1 class="text-3xl font-bold text-yellow-300 mb-4 text-center">éš”ç©ºä¹å™¨æ¼”å¥å° (çº¯å‡€ç‰ˆ)</h1>
        <p class="text-sm text-center mb-4 text-gray-400">ä½¿ç”¨é£ŸæŒ‡åœ¨ä¹å™¨ä¸Šâ€œæ•²å‡»â€è¿›è¡Œæ¼”å¥ã€‚åº”ç”¨æ­£åœ¨è‡ªåŠ¨å¯åŠ¨ï¼Œè¯·æˆæƒæ‘„åƒå¤´ã€‚</p>
        
        <div id="video-canvas-container">
            <video id="video-element" class="hidden" playsinline></video>
            <canvas id="output-canvas"></canvas>
            
            <div id="start-overlay" class="absolute inset-0 bg-gray-800 bg-opacity-95 flex flex-col items-center justify-center z-20">
                <!-- ç§»é™¤å¼€å§‹æŒ‰é’®ï¼Œæ”¹ä¸ºè‡ªåŠ¨å¯åŠ¨ -->
                <p id="loading-text" class="mt-4 text-xl text-red-400 loading-animation">
                    æ­£åœ¨ä¸‹è½½ MediaPipe æ ¸å¿ƒåº“... (æ­£åœ¨è‡ªåŠ¨å¯åŠ¨)
                </p>
            </div>
        </div>
        
        <div class="text-center text-sm mt-2">
            å½“å‰ç”¨æˆ· ID (ç”¨äºæ•°æ®å®‰å…¨): <span id="user-id" class="text-green-400">æ­£åœ¨è®¤è¯...</span>
        </div>
    </div>

    <!-- å¼•å…¥ MediaPipe Hands å’Œ Camera Utils -->
    <script src="https://cdn.mediapipe.dev/hands/0.4/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.mediapipe.dev/camera_utils/0.3/camera_utils.js" crossorigin="anonymous"></script>
    <!-- å¼•å…¥ Tone.js è¿›è¡Œå£°éŸ³åˆæˆ -->
    <script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.min.js"></script>

    <script>
        // ----------------------------------------------------------------------
        // 1. å…¨å±€çŠ¶æ€ & å…ƒç´ è·å–
        // ----------------------------------------------------------------------
        const videoElement = document.getElementById('video-element');
        const canvasElement = document.getElementById('output-canvas');
        const canvasCtx = canvasElement.getContext('2d');
        // ç§»é™¤ startButton 
        const loadingText = document.getElementById('loading-text');
        const startOverlay = document.getElementById('start-overlay');
        const userIdSpan = document.getElementById('user-id');

        let isInitialized = false;
        let mediaPipeReady = false; 
        let modelTimeout = null; 
        let noteParticles = [];
        let lastIndexTipY = 0;
        let isTapping = false;

        let hands = null;
        let camera = null;
        const MODEL_LOAD_TIMEOUT_MS = 30000;

        // ----------------------------------------------------------------------
        // 2. ä¹å™¨é…ç½® (Bounding Boxes)
        // ----------------------------------------------------------------------
        const INSTRUMENTS = [
            { name: 'å‰ä»–', id: 'guitar', sound: null, color: '#f39c12', emoji: 'ğŸ¸', rect: [50, 400, 200, 300], lastTap: 0 },
            { name: 'é¼“', id: 'drum', sound: null, color: '#e74c3c', emoji: 'ğŸ¥', rect: [300, 450, 200, 250], lastTap: 0 },
            { name: 'å°å·', id: 'trumpet', sound: null, color: '#f1c40f', emoji: 'ğŸº', rect: [550, 400, 200, 300], lastTap: 0 },
            { name: 'ä¸‰è§’é“', id: 'triangle', sound: null, color: '#bdc3c7', emoji: 'ğŸ”º', rect: [800, 450, 150, 250], lastTap: 0 }
        ];

        // ----------------------------------------------------------------------
        // 3. Tone.js å£°éŸ³è®¾ç½®
        // ----------------------------------------------------------------------
        function setupAudio() {
            INSTRUMENTS.find(i => i.id === 'guitar').sound = new Tone.PluckSynth().toDestination();
            INSTRUMENTS.find(i => i.id === 'drum').sound = new Tone.NoiseSynth({
                noise: { type: 'pink' },
                envelope: { attack: 0.005, decay: 0.1, sustain: 0, release: 0.2 }
            }).toDestination();
            INSTRUMENTS.find(i => i.id === 'trumpet').sound = new Tone.Synth({
                oscillator: { type: 'square' },
                envelope: { attack: 0.05, decay: 0.3, sustain: 0.1, release: 0.5 },
                volume: -10
            }).toDestination();
            INSTRUMENTS.find(i => i.id === 'triangle').sound = new Tone.MetalSynth({
                frequency: 200,
                envelope: { attack: 0.001, decay: 0.2, release: 0.1 },
                harmonicity: 5.1,
                modulationIndex: 32,
                octaves: 1,
                volume: -15
            }).toDestination();
        }
        
        // é¡µé¢é¦–æ¬¡ç‚¹å‡»æ—¶å¯åŠ¨ AudioContext
        // è¿™æ˜¯ä¸ºäº†ç»•è¿‡æµè§ˆå™¨å¯¹è‡ªåŠ¨æ’­æ”¾åª’ä½“çš„é™åˆ¶
        document.documentElement.addEventListener('click', () => {
            if (Tone.context.state !== 'running') {
                Tone.start();
            }
        }, { once: true });


        // ----------------------------------------------------------------------
        // 4. MediaPipe Hands è®¾ç½® 
        // ----------------------------------------------------------------------
        function onResults(results) {
            // é¦–æ¬¡æˆåŠŸè·å–ç»“æœæ—¶ï¼Œæ¸…é™¤æ¨¡å‹åŠ è½½è¶…æ—¶è®¡æ—¶å™¨
            if (modelTimeout) {
                clearTimeout(modelTimeout);
                modelTimeout = null; 
                console.log("MediaPipe Model confirmed loaded via onResults.");
            }

            const width = 1000;
            const height = 750;
            canvasElement.width = width;
            canvasElement.height = height;

            canvasCtx.save();
            // é•œåƒç¿»è½¬è§†é¢‘æµï¼Œä½¿æ‰‹éƒ¨è¿åŠ¨ç¬¦åˆç›´è§‰
            canvasCtx.clearRect(0, 0, width, height);
            canvasCtx.scale(-1, 1);
            canvasCtx.translate(-width, 0);
            canvasCtx.drawImage(results.image, 0, 0, width, height);
            canvasCtx.restore();

            drawInstruments(width, height);

            if (results.multiHandLandmarks) {
                for (const landmarks of results.multiHandLandmarks) {
                    const indexTip = landmarks[8]; // è·å–é£ŸæŒ‡æŒ‡å°– (Landmark 8)
                    const x = width - (indexTip.x * width); // è½¬æ¢åæ ‡å¹¶é•œåƒ
                    const y = indexTip.y * height;
                    
                    drawIndexTip(x, y);

                    const currentTime = performance.now();
                    // æ£€æµ‹å‚ç›´æ–¹å‘ä¸Šçš„å¿«é€Ÿç§»åŠ¨ (æ•²å‡»)
                    const tapSpeed = Math.abs(y - lastIndexTipY); 

                    // é˜ˆå€¼åˆ¤æ–­æ˜¯å¦æ­£åœ¨æ•²å‡»
                    let isCurrentlyTapping = tapSpeed > 5;

                    if (isCurrentlyTapping && !isTapping) {
                        checkTouch(x, y, currentTime);
                    }
                    
                    isTapping = isCurrentlyTapping;
                    lastIndexTipY = y;
                }
            }

            drawNoteParticles();
        }

        function handleModelStuck() {
            clearTimeout(modelTimeout);
            loadingText.textContent = 'âŒ æ¨¡å‹åŠ è½½è¶…æ—¶ï¼è¯·æ£€æŸ¥ç½‘ç»œï¼Œç„¶ååˆ·æ–°é¡µé¢é‡è¯•ã€‚';
            loadingText.classList.remove('loading-animation', 'text-yellow-400'); 
            loadingText.classList.add('text-red-600');
            console.error("MediaPipe Model Load Timeout: Failed to download model files.");
        }


        function initializeMediaPipe() {
            hands = new Hands({
                locateFile: (file) => {
                    return `https://cdn.mediapipe.dev/hands/0.4/${file}`;
                }
            });

            hands.setOptions({
                maxNumHands: 1,
                modelComplexity: 0, 
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });

            hands.onResults(onResults);
            
            // åº“åŠ è½½å®Œæˆåï¼Œæ›´æ–°çŠ¶æ€å¹¶ç«‹å³å°è¯•å¯åŠ¨æ‘„åƒå¤´
            loadingText.textContent = 'âœ… æ ¸å¿ƒæ¨¡å‹åŠ è½½å®Œæ¯•ï¼Œæ­£åœ¨è¯·æ±‚æ‘„åƒå¤´æƒé™...';
            loadingText.classList.remove('loading-animation'); // åœæ­¢åŠ¨ç”»
            loadingText.classList.remove('text-red-400');
            loadingText.classList.add('text-yellow-400'); // æç¤ºè‰²
            
            camera = new Camera(videoElement, {
                onFrame: async () => {
                    if (isInitialized && hands) {
                        await hands.send({ image: videoElement });
                    }
                    requestAnimationFrame(animateParticles);
                },
                width: 1000,
                height: 750
            });
            
            // è‡ªåŠ¨å¯åŠ¨æ‘„åƒå¤´
            startCamera();
        }
        
        // ----------------------------------------------------------------------
        // 5. ç»˜å›¾å‡½æ•° 
        // ----------------------------------------------------------------------

        function drawInstruments(width, height) {
            const font = 'monospace, sans-serif'; 
            canvasCtx.textBaseline = 'middle';
            canvasCtx.textAlign = 'center';

            INSTRUMENTS.forEach(inst => {
                const [x, y, w, h] = inst.rect;

                // ç»˜åˆ¶ä¹å™¨ä¸»ä½“
                canvasCtx.fillStyle = inst.color;
                canvasCtx.fillRect(x, y, w, h);
                canvasCtx.strokeStyle = '#2c3e50';
                canvasCtx.lineWidth = 6;
                canvasCtx.strokeRect(x, y, w, h);

                // ç»˜åˆ¶ä¹å™¨å›¾æ ‡ (Emoji)
                canvasCtx.fillStyle = '#ecf0f1';
                canvasCtx.font = `bold 60px ${font}`;
                canvasCtx.fillText(inst.emoji, x + w / 2, y + h / 2 - 20);

                // ç»˜åˆ¶ä¹å™¨åç§°
                canvasCtx.font = `bold 30px ${font}`;
                canvasCtx.fillText(inst.name, x + w / 2, y + h / 2 + 30);
                
                // åƒç´ è¾¹æ¡†æ•ˆæœ
                canvasCtx.strokeStyle = '#000000';
                canvasCtx.lineWidth = 2;
                canvasCtx.strokeRect(x + 5, y + 5, w - 10, h - 10);
            });
        }

        function drawIndexTip(x, y) {
            const size = 20;
            // ç»˜åˆ¶çº¢è‰²æ–¹å—ä½œä¸ºæŒ‡å°–æŒ‡ç¤ºå™¨
            canvasCtx.fillStyle = '#ff0000';
            canvasCtx.fillRect(x - size / 2, y - size / 2, size, size);
            
            // ç»˜åˆ¶ç™½è‰²è¾¹æ¡†
            canvasCtx.strokeStyle = '#ffffff';
            canvasCtx.lineWidth = 4;
            canvasCtx.strokeRect(x - size / 2, y - size / 2, size, size);
            
            // ç»˜åˆ¶é»„è‰²ä¸­å¿ƒç‚¹
            canvasCtx.fillStyle = '#ffff00';
            canvasCtx.fillRect(x - 2, y - 2, 4, 4);
        }

        function drawNoteParticles() {
            noteParticles.forEach(p => {
                canvasCtx.font = `${p.size}px monospace`;
                canvasCtx.fillStyle = p.color;
                canvasCtx.fillText(p.char, p.x, p.y);
            });
        }
        
        // ----------------------------------------------------------------------
        // 6. ç²’å­åŠ¨ç”» 
        // ----------------------------------------------------------------------

        function createNoteParticle(x, y, color) {
            const notes = ['ğŸµ', 'ğŸ¶', 'â™©', 'â™ª', 'â™«', 'â™¬'];
            noteParticles.push({
                x: x,
                y: y,
                vx: (Math.random() - 0.5) * 5, // æ°´å¹³é€Ÿåº¦
                vy: -(Math.random() * 10 + 5), // å‘ä¸Šé€Ÿåº¦
                char: notes[Math.floor(Math.random() * notes.length)],
                size: 20,
                color: color,
                life: 60 // ç”Ÿå‘½å‘¨æœŸ
            });
        }

        function animateParticles() {
            noteParticles = noteParticles.map(p => {
                p.x += p.vx;
                p.y += p.vy;
                p.vy *= 0.95; // æ¨¡æ‹Ÿé‡åŠ›å‡é€Ÿ
                p.life--;
                return p;
            }).filter(p => p.life > 0);
        }
        
        // ----------------------------------------------------------------------
        // 7. äº¤äº’ä¸å£°éŸ³é€»è¾‘ 
        // ----------------------------------------------------------------------

        function checkTouch(tipX, tipY, currentTime) {
            INSTRUMENTS.forEach(inst => {
                const [x, y, w, h] = inst.rect;
                
                // æ£€æŸ¥æŒ‡å°–æ˜¯å¦åœ¨ä¹å™¨è¾¹ç•Œå†…
                if (tipX > x && tipX < x + w && tipY > y && tipY < y + h) {
                    
                    const timeSinceLastTap = currentTime - inst.lastTap;
                    inst.lastTap = currentTime;

                    // æ ¹æ®æ•²å‡»é€Ÿåº¦ (BPM) è°ƒæ•´å£°éŸ³å‚æ•° (ä¾‹å¦‚é¼“çš„è¡°å‡æ—¶é—´)
                    const minBPM = 60;
                    const maxBPM = 240;
                    const minInterval = 100; // æœ€å¿«æ•²å‡»é—´éš” (ms)
                    const maxInterval = 1000; // æœ€æ…¢æ•²å‡»é—´éš” (ms)
                    
                    let mappedBPM = minBPM;
                    if (timeSinceLastTap < maxInterval) {
                        const clampedInterval = Math.max(minInterval, Math.min(maxInterval, timeSinceLastTap));
                        const normalized = 1 - (clampedInterval - minInterval) / (maxInterval - minInterval);
                        mappedBPM = minBPM + normalized * (maxBPM - minBPM);
                    }
                    
                    const intervalInSeconds = 60 / mappedBPM;

                    playSound(inst, intervalInSeconds);

                    // åˆ›å»ºéŸ³ç¬¦ç²’å­ç‰¹æ•ˆ
                    createNoteParticle(x + w / 2, y, inst.color);
                    
                    return; 
                }
            });
        }
        
        function playSound(inst, interval) {
            if (Tone.context.state !== 'running') {
                Tone.start();
            }

            switch (inst.id) {
                case 'guitar':
                    // å‰ä»–: æ‹¨å¼¦éŸ³
                    inst.sound.triggerAttackRelease('C4', '8n');
                    break;
                case 'drum':
                    // é¼“: å™ªæ³¢éŸ³ï¼Œè¡°å‡æ—¶é—´ä¸æ•²å‡»é€Ÿåº¦ç›¸å…³
                    inst.sound.triggerAttackRelease(interval / 2);
                    break;
                case 'trumpet':
                    // å°å·: æ–¹æ³¢ï¼ŒæŒç»­æ—¶é—´ä¸æ•²å‡»é€Ÿåº¦ç›¸å…³
                    inst.sound.oscillator.type = 'square';
                    inst.sound.triggerAttackRelease('G4', interval / 1.5, Tone.now(), 0.5);
                    break;
                case 'triangle':
                    // ä¸‰è§’é“: é‡‘å±åˆæˆéŸ³ï¼Œé¢‘ç‡ç•¥å¾®éšæœº
                    inst.sound.triggerAttackRelease(250 + Math.random() * 50, 0.5);
                    break;
            }
        }

        // ----------------------------------------------------------------------
        // 8. å¯åŠ¨é€»è¾‘ 
        // ----------------------------------------------------------------------

        async function startCamera() {
            setupAudio(); // åˆå§‹åŒ–å£°éŸ³
            
            try {
                if (camera) {
                    await camera.start(); // å°è¯•å¯åŠ¨æ‘„åƒå¤´
                }
                
                isInitialized = true;
                startOverlay.classList.add('hidden'); // å¯åŠ¨æˆåŠŸåéšè—è¦†ç›–å±‚
                
                // å¤„ç† Firebase è®¤è¯çŠ¶æ€æ˜¾ç¤º
                const auth = window.authInstance;
                const onAuthStateChanged = window.onAuthStateChanged;
                
                if (auth && onAuthStateChanged) {
                    onAuthStateChanged(auth, user => {
                        if (user) {
                            userIdSpan.textContent = user.uid;
                        } else {
                            userIdSpan.textContent = 'åŒ¿å';
                        }
                    });
                } else {
                    userIdSpan.textContent = 'Firebase æœªåˆå§‹åŒ–';
                }

            } catch (error) {
                console.error('æ— æ³•å¯åŠ¨æ‘„åƒå¤´:', error);
                startOverlay.classList.remove('hidden');
                loadingText.classList.remove('hidden');
                loadingText.classList.remove('text-yellow-400');
                loadingText.textContent = `âŒ å¯åŠ¨å¤±è´¥: ${error.name}. è¯·æ£€æŸ¥æ‘„åƒå¤´æƒé™ï¼Œç„¶ååˆ·æ–°é¡µé¢é‡è¯•ã€‚`;
            }
        }

        function checkMediaPipeReady() {
            if (mediaPipeReady) return; 

            // æ£€æŸ¥ MediaPipe åº“æ˜¯å¦åŠ è½½å®Œæ¯•
            if (typeof Hands !== 'undefined' && typeof Camera !== 'undefined') {
                initializeMediaPipe(); 
                mediaPipeReady = true;
                
                // å¯åŠ¨æ¨¡å‹åŠ è½½è¶…æ—¶è®¡æ—¶å™¨
                modelTimeout = setTimeout(handleModelStuck, MODEL_LOAD_TIMEOUT_MS); 
                
            } else {
                // å¦‚æœæ²¡æœ‰åŠ è½½å®Œæ¯•ï¼Œç¨åé‡è¯•
                setTimeout(checkMediaPipeReady, 100);
            }
        }

        window.addEventListener('resize', () => {
            const container = document.getElementById('video-canvas-container');
            canvasElement.style.width = container.offsetWidth + 'px';
            canvasElement.style.height = container.offsetHeight + 'px';
        });

        window.onload = () => {
            const container = document.getElementById('video-canvas-container');
            canvasElement.style.width = container.offsetWidth + 'px';
            canvasElement.style.height = container.offsetHeight + 'px';

            // é¡µé¢åŠ è½½å®Œæˆç›´æ¥å¼€å§‹ MediaPipe æ£€æŸ¥å’Œè‡ªåŠ¨å¯åŠ¨æµç¨‹
            checkMediaPipeReady(); 
        };

    </script>
</body>
</html